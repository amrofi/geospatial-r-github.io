<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>geographically-wighted-random-forest.utf8</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Geospatial Data Science in R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="getting-started-with-r.html">Getting Started with R</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Spatial Data Processing
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="about.html">Content</a>
    </li>
    <li>
      <a href="read-write-spatial-data.html">Read and Write Spatial Data</a>
    </li>
    <li>
      <a href="map-projection-coordinate-reference-systems.html">Map Projection and Coordinate Reference Systems</a>
    </li>
    <li>
      <a href="geoprocessing-vector-data.html">Geoprocessing of Vector data</a>
    </li>
    <li>
      <a href="working-with-spatial-point-data.html">Working with Spatial Point Data</a>
    </li>
    <li>
      <a href="working-with-spatial-polygon.html">Working with Spatial Polygon Data</a>
    </li>
    <li>
      <a href="working-with-raster-data.html">Working with Raster Data</a>
    </li>
    <li>
      <a href="netCDF-data-processing.html">netCDF Data Processing</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Spatial Statistics
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="about-b.html">Content</a>
    </li>
    <li>
      <a href="spatial-autocorrelation.html">Spatial Autocorrelation</a>
    </li>
    <li>
      <a href="point-pattern-analysis.html">Point Pattern Analysis</a>
    </li>
    <li>
      <a href="geographically-weighted-models.html">Geographically Weighted Model</a>
    </li>
    <li>
      <a href="geographically-weighted-summary-statistics.html">Geographically Weighted Summary Statistics</a>
    </li>
    <li>
      <a href="geographically-weighted-principal-components-analysis.html">Geographically Weighted Principal Components Analysis</a>
    </li>
    <li>
      <a href="geographically-weighted-regression.html">Geographically Weighted Regression</a>
    </li>
    <li>
      <a href="geographically-weighted-ols-regression.html">Geographically Weighted OLS Regression</a>
    </li>
    <li>
      <a href="geographically-weighted-poisson-regression.html">Geographically Weighted Poisson Regression</a>
    </li>
    <li>
      <a href="geographically-wighted-random-forest.html">Global and Local (geographically weighted) Random Forest</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Spatial Interpolation
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="about-d.html">Content</a>
    </li>
    <li>
      <a href="deterministic-methods-for-spatial-interpolation.html">Deterministic Methods for Spatial Interpolation</a>
    </li>
    <li>
      <a href="geostatistical-methods-for-spatial-interpolation.html">Geostatistical Methods for Spatial Interpolation</a>
    </li>
    <li>
      <a href="semivariogram-modeling.html">Semivariogram Modeling</a>
    </li>
    <li>
      <a href="kriging.html">Kriging</a>
    </li>
    <li>
      <a href="ordinary-kriging.html">Ordinary Kriging</a>
    </li>
    <li>
      <a href="universal-kriging.html">Universal Kriging</a>
    </li>
    <li>
      <a href="cokriging.html">Co-Kriging</a>
    </li>
    <li>
      <a href="regression-kriging.html">Regression kriging</a>
    </li>
    <li>
      <a href="indicator-kriging.html">Indicator kriging</a>
    </li>
    <li>
      <a href="assessing-quality-spatial-predictions.html">Assessing the Quality of Spatial Predictions</a>
    </li>
    <li>
      <a href="cross-validation.html">Cross-validation</a>
    </li>
    <li>
      <a href="validation-independent-dataset.html">Validation with an Independent Dataset</a>
    </li>
    <li>
      <a href="conditional-simulation-spatial-uncertainty.html">Conditional Simulation for Spatial Uncertainty</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Remote Sensing
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="about-c.html">Content</a>
    </li>
    <li>
      <a href="reomte-sensing-basic.html">Remote Sensing Basic</a>
    </li>
    <li>
      <a href="landsat-8-image-processing.html">Landsat 8 Image Processing &amp; Visualization</a>
    </li>
    <li>
      <a href="spectral-indices.html">Spectral Indices</a>
    </li>
    <li>
      <a href="uav-ground-cover.html">Green Ground Cover from UAV Images</a>
    </li>
    <li>
      <a href="texture-analysis.html">Texture Analysis</a>
    </li>
    <li>
      <a href="image-classification.html">Image Classification</a>
    </li>
    <li>
      <a href="ground-truth-data-processing.html">Ground Truth Data Processing</a>
    </li>
    <li>
      <a href="unsupervised-classification.html">Unsupervised Classification</a>
    </li>
    <li>
      <a href="supervised-classification.html">Supervised Classification</a>
    </li>
    <li>
      <a href="random-forest.html">Random Forest</a>
    </li>
    <li>
      <a href="support-vector-machine.html">Support Vector Machine</a>
    </li>
    <li>
      <a href="naive-bayes.html">Naïve Bayes</a>
    </li>
    <li>
      <a href="exboost.html">eXtreme Gradient Boosting</a>
    </li>
    <li>
      <a href="deep-learning-h2o.html">Deep Learning with H20</a>
    </li>
    <li>
      <a href="stack-ensemble-h2o.html">Stack-Ensemble-H20</a>
    </li>
    <li>
      <a href="deep-learning-keras-tensorflow.html">Deep Learning with Keras-TensorFlow</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="mailto:zia207@gmail.com">
    <span class="fa fa-envelope fa-lg"></span>
     
    Email
  </a>
</li>
<li>
  <a href="http://github.com/zia207">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://www.linkedin.com/in/zia-ahmed-a7653578">
    <span class="fa fa-linkedin fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">




</div>


<div style="margin-bottom:10px;">

</div>
<img src="Image/empty_banner.png" width="100%" style="display: block; margin: auto;" />
<div style="margin-bottom:20px;">

</div>
<div id="global-and-local-random-forest-regression" class="section level1">
<h1>Global and Local Random Forest Regression</h1>
<p>In this exercise, you will learn how to fit global and local (Geographically weighted) random forest regression models to predict county-level LBC mortality rate from poverty, smoking, the annual mean of PM25, NO2, and SO2 data. The data for the year 2010 will be used to train the models and the data for the year 2011 were used as a validation data set for optimizing the model parameters during the tuning and training processes. The data set for the year 2012 will be used as the hold-out test data to evaluate the performance of both global and local RF models. Also, you will learn some of the necessary interpretations of machine learning output.</p>
<p>This data could be found <a href="https://www.dropbox.com/s/lrz6og0ld2m64df/Data_GWR.7z?dl=0">here</a></p>
<ul>
<li><p><a href="#global-random-forest">Global Random Forest</a></p></li>
<li><p><a href="#local-random-forest">Local Random Forest</a></p></li>
</ul>
<div id="load-r-packages" class="section level5">
<h5>Load R packages</h5>
<pre class="r"><code>library(GWmodel)      ## GW models
library(plyr)         ## Data management
library(sp)           ## Spatial Data management
library(spdep)        ## Spatial autocorrelation
library(RColorBrewer) ## Visualization
library(classInt)     ## Class intervals
library(raster)       ## spatial data
library(grid)         ## plot
library(gridExtra)    ## Multiple plot
library(ggplot2)      #  plotting
library(tidyverse)    # data 
library(SpatialML)    # Geographically weigted regression</code></pre>
</div>
<div id="load-data" class="section level4">
<h4>Load Data</h4>
<pre class="r"><code># Define data folder
dataFolder&lt;-&quot;D:\\Dropbox\\Spatial Data Analysis and Processing in R\\Data_GWR\\&quot;
county&lt;-shapefile(paste0(dataFolder,&quot;COUNTY_ATLANTIC.shp&quot;))
state.bd&lt;-shapefile(paste0(dataFolder,&quot;STATE_ATLANTIC.shp&quot;))
df&lt;-read.csv(paste0(dataFolder,&quot;data_all_1998_2012.csv&quot;), header=T)
state &lt;- list(&quot;sp.lines&quot;, as(state.bd, &quot;SpatialLines&quot;), col=&quot;grey50&quot;, lwd=.7,lty=3) </code></pre>
</div>
<div id="create-training-2010-validation-2011-and-test-2012-data" class="section level4">
<h4>Create training (2010), validation (2011) and test (2012) data</h4>
<pre class="r"><code>test.df&lt;-df %&gt;% 
  dplyr::select(FIPS, X, Y, Year, POVERTY, SMOKING, PM25, NO2, SO2, Rate) %&gt;%
  filter(Year == 2012)

valid.df&lt;-df %&gt;% 
  dplyr::select(FIPS, X, Y, Year, POVERTY, SMOKING, PM25, NO2, SO2, Rate) %&gt;%
  filter(Year == 2011)

train.df&lt;-df %&gt;% 
  dplyr::select(FIPS, X, Y,  Year, POVERTY, SMOKING, PM25, NO2, SO2, Rate) %&gt;%
  filter(Year == 2010)</code></pre>
</div>
<div id="scale-covariates" class="section level4">
<h4>Scale covariates</h4>
<pre class="r"><code>test.df[, 5:9] = scale(test.df[, 5:9])
valid.df[, 5:9] = scale(valid.df[, 5:9])
train.df[, 5:9] = scale(train.df[, 5:9])</code></pre>
</div>
<div id="global-random-forest" class="section level2">
<h2>Global Random Forest</h2>
<p>We use Distributed Random Forest (DRF) in h20 package to fit global RF model. DRF generates a forest of classification or regression trees, rather than a single classification or regression tree. Each of these trees is a weak learner built on a subset of rows and columns. More trees will reduce the variance. Both classification and regression take the average prediction over all of their trees to make a final prediction,</p>
<div id="grid-search-for-hyperprameters" class="section level3">
<h3>Grid Search for hyperprameters</h3>
<p>Before fit DRF model, we will use a Random Grid Search (RGS) to find the optimal parameters for RF model. We will employ the 10-fold cross validation method to determine the optimal hyper-parameters from a set of all possible hyper-parameter value combinations. During the parameter tuning process, we wiil usw 0.001 and 2 for “stopping tolerance” and “stopping rounds”, respectively, as early stopping parameters. The best DRF will be used to predict LBC mortality rate for the year 2012.</p>
<div id="connect-to-h20" class="section level4">
<h4>Connect to H20</h4>
<pre class="r"><code>library(h2o)
h2o.init(nthreads = -1,max_mem_size =&quot;48g&quot;,enable_assertions = FALSE)</code></pre>
</div>
<div id="create-h20-dataframes" class="section level4">
<h4>Create h20 dataframes</h4>
<pre class="r"><code>test.mf&lt;-test.df[, 5:10] 
valid.mf&lt;-valid.df[, 5:10]
train.mf&lt;-train.df[, 5:10]

test.hex&lt;-  as.h2o(test.mf)
valid.hex&lt;-  as.h2o(valid.mf)
train.hex&lt;-  as.h2o(train.mf)</code></pre>
</div>
<div id="define-response-and-predictors" class="section level4">
<h4>Define response and predictors</h4>
<pre class="r"><code>response &lt;- &quot;Rate&quot;
predictors &lt;- setdiff(names(train.hex), response)</code></pre>
<div style="margin-bottom:40px;">

</div>
<pre class="r"><code># Hyper-parameter
drf_hyper_params &lt;-list(
              ntrees  = seq(10, 5000, by = 10),
              max_depth=c(10,20,30,40,50),
              sample_rate=c(0.7, 0.8, 0.9, 1.0)
              )

#  serach criteria
drf_search_criteria &lt;- list(strategy = &quot;RandomDiscrete&quot;, 
                        max_models = 200,
                        max_runtime_secs = 900,
                        stopping_tolerance = 0.001,
                        stopping_rounds = 2,
                        seed = 1345767)
# Grid Search
drf_grid &lt;- h2o.grid(
                  algorithm=&quot;randomForest&quot;,
                  grid_id = &quot;drf_grid_IDx&quot;,
                  x= predictors,
                  y = response,
                  training_frame = train.hex,
                  validation_frame = valid.hex,
                  stopping_metric = &quot;RMSE&quot;,
                  nfolds=10,
                  keep_cross_validation_predictions = TRUE,
                  hyper_params = drf_hyper_params,
                  search_criteria = drf_search_criteria,
                  seed = 42)</code></pre>
</div>
</div>
<div id="drf-grid-parameters" class="section level3">
<h3>DRF Grid parameters</h3>
<pre class="r"><code># RF Grid parameters
drf_get_grid &lt;- h2o.getGrid(&quot;drf_grid_IDx&quot;,sort_by=&quot;RMSE&quot;,decreasing=FALSE)
drf_get_grid@summary_table[1,]</code></pre>
</div>
<div id="the-best-drf-model" class="section level3">
<h3>The Best DRF Model</h3>
<pre class="r"><code>best_drf &lt;- h2o.getModel(drf_get_grid@model_ids[[1]]) 
#capture.output(print(summary(best_drf)),file =  &quot;DRF_summary_N_RY.txt&quot;)
best_drf</code></pre>
</div>
<div id="drf-cross-validation" class="section level3">
<h3>DRF Cross-validation</h3>
<pre class="r"><code>cv.drf&lt;-best_drf@model$cross_validation_metrics_summary%&gt;%.[,c(1,2)]
cv.drf</code></pre>
<div style="margin-bottom:40px;">

</div>
</div>
</div>
<div id="prediction" class="section level2">
<h2>Prediction</h2>
<pre class="r"><code># Creat a data-frame
FIPS.xy&lt;-test.df[,1:3]
FIPS.xy$Obs_2011&lt;-valid.df[,10]
FIPS.xy$Obs_2012&lt;-test.df[,10]
# validation data
pred.valid&lt;-as.data.frame(h2o.predict(object = best_drf, newdata = valid.hex))</code></pre>
<pre><code>## 
  |                                                                       
  |                                                                 |   0%
  |                                                                       
  |=================================================================| 100%</code></pre>
<pre class="r"><code>FIPS.xy$RF_2011&lt;-pred.valid$predict
# test data
pred.test&lt;-as.data.frame(h2o.predict(object = best_drf, newdata = test.hex))</code></pre>
<pre><code>## 
  |                                                                       
  |                                                                 |   0%
  |                                                                       
  |=================================================================| 100%</code></pre>
<pre class="r"><code>FIPS.xy$RF_2012&lt;-pred.test$predict</code></pre>
<pre class="r"><code>cat(&#39;RF Validation RMSE:&#39;, round(sqrt(mean((FIPS.xy$RF_2011-FIPS.xy$Obs_2011)^2 , na.rm = TRUE)), digits=3), &#39;\n&#39;)</code></pre>
<pre><code>## RF Validation RMSE: 7.818</code></pre>
<pre class="r"><code>cat(&#39;RF Validation MAE:&#39;, round(mean(abs(FIPS.xy$RF_2011-FIPS.xy$Obs_2011) , na.rm = TRUE ), digits=3), &#39;\n&#39;)</code></pre>
<pre><code>## RF Validation MAE: 6.027</code></pre>
<pre class="r"><code>cat(&#39;RF Validation R2:&#39;, round(summary(lm(Obs_2011~RF_2011,FIPS.xy))$r.squared, digits=3), &#39;\n&#39;)</code></pre>
<pre><code>## RF Validation R2: 0.647</code></pre>
<pre class="r"><code>cat(&#39;RF Test RMSE:&#39;, round(sqrt(mean((FIPS.xy$RF_2012-FIPS.xy$Obs_2012)^2 , na.rm = TRUE)), digits=3), &#39;\n&#39;)</code></pre>
<pre><code>## RF Test RMSE: 8.887</code></pre>
<pre class="r"><code>cat(&#39;RF Test MAE:&#39;, round(mean(abs(FIPS.xy$RF_2012-FIPS.xy$Obs_2012) , na.rm = TRUE ), digits=3), &#39;\n&#39;)</code></pre>
<pre><code>## RF Test MAE: 6.772</code></pre>
<pre class="r"><code>cat(&#39;RF Test R2:&#39;, round(summary(lm(Obs_2012~RF_2012,FIPS.xy))$r.squared, digits=3), &#39;\n&#39;)</code></pre>
<pre><code>## RF Test R2: 0.556</code></pre>
</div>
<div id="rf-predicted-11-plot" class="section level2">
<h2>RF Predicted 1:1 Plot</h2>
<div id="validation-data-year-2011" class="section level3">
<h3>Validation data (year 2011)</h3>
<pre class="r"><code>p.valid&lt;-ggplot(data=FIPS.xy, aes(x=Obs_2011, y=RF_2011))+ 
  geom_point(size = 1.0)+
  geom_smooth(method = &quot;lm&quot;, se = FALSE, colour=&quot;black&quot;,size=0.5)+
  scale_x_continuous(limits=c(20,120), breaks=seq(20, 120, 20))+ 
  scale_y_continuous(limits=c(20,120), breaks=seq(20, 120, 20)) +
  theme_light() +
  ggtitle(&quot;Validation data: 2011&quot;)+
  theme(
    plot.title = element_text(color=&quot;black&quot;, size=12,hjust = 0.5),
    panel.background = element_rect(fill = &quot;white&quot;,colour = &quot;gray75&quot;,size = 0.5, linetype = &quot;solid&quot;),
    axis.line = element_line(colour = &quot;grey&quot;),
    panel.grid.major = element_blank(),
    axis.text.x=element_text(size=10, colour=&quot;black&quot;),
    axis.text.y=element_text(size=10,angle = 90,vjust = 0.5, hjust=0.5, colour=&#39;black&#39;))+
  geom_abline(slope=1, intercept=0,linetype=&quot;dashed&quot;,size=0.5)+
  labs(x=&quot;Observed&quot;, y = &quot;Predicted&quot;) </code></pre>
</div>
<div id="test-data-year-2012" class="section level3">
<h3>Test data (year 2012)</h3>
<pre class="r"><code>p.test&lt;-ggplot(data=FIPS.xy, aes(x=Obs_2012, y=RF_2012))+ 
  geom_point(size = 1.0)+
  geom_smooth(method = &quot;lm&quot;, se = FALSE, colour=&quot;black&quot;,size=0.5)+
  scale_x_continuous(limits=c(20,120), breaks=seq(20, 120, 20))+ 
  scale_y_continuous(limits=c(20,120), breaks=seq(20, 120, 20)) +
  theme_light() +
  ggtitle(&quot;Test data - 2012&quot;)+
  theme(
    plot.title = element_text(color=&quot;black&quot;, size=12,hjust = 0.5),
    panel.background = element_rect(fill = &quot;white&quot;,colour = &quot;gray75&quot;,size = 0.5, linetype = &quot;solid&quot;),
    axis.line = element_line(colour = &quot;grey&quot;),
    panel.grid.major = element_blank(),
    axis.text.x=element_text(size=10, colour=&quot;black&quot;),
    axis.text.y=element_text(size=10,angle = 90,vjust = 0.5, hjust=0.5, colour=&#39;black&#39;))+
  geom_abline(slope=1, intercept=0,linetype=&quot;dashed&quot;,size=0.5)+
  labs(x=&quot;Observed&quot;, y = &quot;Predicted&quot;) </code></pre>
</div>
<div id="plot-all" class="section level3">
<h3>Plot all</h3>
<pre class="r"><code>grid.arrange(p.valid,p.test, 
            ncol= 2, 
            heights = c(30,6), 
            top = textGrob(&quot;Random Forest Predicted LBC Mortality Rate 
                          \n(death per 100,000)&quot;,gp=gpar(fontsize=18)))</code></pre>
<p><img src="geographically-wighted-random-forest_files/figure-html/unnamed-chunk-18-1.png" width="768" style="display: block; margin: auto;" /></p>
</div>
<div id="map-predicted-values" class="section level3">
<h3>Map predicted values</h3>
<pre class="r"><code>rf.SPDF&lt;-merge(county, FIPS.xy, by=&quot;FIPS&quot;)
names(rf.SPDF)</code></pre>
<pre><code>##  [1] &quot;FIPS&quot;       &quot;ID&quot;         &quot;x&quot;          &quot;y&quot;          &quot;REGION_ID&quot; 
##  [6] &quot;DIVISION_I&quot; &quot;STATE_ID&quot;   &quot;COUNTY_ID&quot;  &quot;REGION&quot;     &quot;DIVISION&quot;  
## [11] &quot;STATE&quot;      &quot;COUNTY&quot;     &quot;X&quot;          &quot;Y&quot;          &quot;Obs_2011&quot;  
## [16] &quot;Obs_2012&quot;   &quot;RF_2011&quot;    &quot;RF_2012&quot;</code></pre>
<pre class="r"><code>myPalette &lt;- colorRampPalette(c(&quot;blue&quot;,&quot;green&quot;, &quot;yellow&quot;, &quot;red&quot;, &quot;red4&quot;))

spplot(rf.SPDF, 
        c(&quot;RF_2011&quot;, &quot;RF_2012&quot;, &quot;Obs_2011&quot;, &quot;Obs_2012&quot; ),         
         layout=c(2, 2),
         par.strip.text=list(cex=1, lines=1, col=&quot;black&quot;),
         main = list( &quot;Random Forest Predicted LBC Mortality Rate 
                 \n(death per 100,000)&quot;, adj = 0.5),
         sp.layout=list(state),
         par.settings=list(strip.background=list(col=&quot;transparent&quot;),
                             strip.border = list(col = &#39;grey95&#39;,lwd=0.5),
                             axis.line=list(col=&quot;grey95&quot;,lwd=0.5)),
         col=&quot;transparent&quot;,
         colorkey=list(space=&quot;right&quot;,height=1, width=2,labels=list(cex=1.75)),
         col.regions=myPalette(100))</code></pre>
<p><img src="geographically-wighted-random-forest_files/figure-html/unnamed-chunk-20-1.png" width="576" style="display: block; margin: auto;" /></p>
<div style="margin-bottom:50px;">

</div>
</div>
</div>
<div id="interpretable-machine-learning" class="section level2">
<h2>Interpretable Machine Learning</h2>
<pre class="r"><code># load Model interpretability packages
library(pdp)       # for partial dependence plots (and ICE curves)
library(vip)       # for variable importance plots</code></pre>
<p>The following code extracts these items for the h2o example:</p>
<pre class="r"><code># 1) create a data frame with just the features
features &lt;- as.data.frame(train.hex) %&gt;%  dplyr::select(-Rate)

# 2) Create a vector with the actual responses
response &lt;- as.data.frame(train.hex) %&gt;% pull(Rate)

# 3) Create custom predict function that returns the predicted values as a vector
pred &lt;- function(object, newdata)  {
  results &lt;- as.vector(h2o.predict(object, as.h2o(newdata)))
  return(results)
  }</code></pre>
</div>
<div id="permutation-based-feature-importance" class="section level2">
<h2>Permutation-based feature importance</h2>
<p>Permutation Feature Importance (PFI) approach (Fisher et al., 2018) was will be applied to rank the predictors of the RF ML model. The PFI approach measures the importance of a feature by calculating the increase in the model’s prediction error after permuting the feature. We will used “vip” package (Greenwell and Boehmke, 2019) for calculating variable importance scores with 10 Monte Carlo simulations. RMSE was used in computing model performance and all measures of importance were scaled to have a maximum value of 100.</p>
<pre class="r"><code>per.var.imp&lt;-vip(
  best_drf,
  train = as.data.frame(train.hex),
  method = &quot;permute&quot;,
  target = &quot;Rate&quot;,
  metric = &quot;RMSE&quot;,
  nsim = 5,
  sample_frac = 0.5,
  pred_wrapper = pred
)</code></pre>
<pre class="r"><code>per.var.imp&lt;-per.var.imp$data
# Scale the importance
per.var.imp$Rank&lt;-(per.var.imp$Importance-min(per.var.imp$Importance))*100/(max(per.var.imp$Importance)-min(per.var.imp$Importance))
head(per.var.imp)</code></pre>
<pre><code>## # A tibble: 5 x 4
##   Variable Importance StDev   Rank
##   &lt;chr&gt;         &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
## 1 SMOKING        7.47 0.593 100   
## 2 POVERTY        4.73 0.347  31.0 
## 3 PM25           4.11 0.324  15.2 
## 4 SO2            3.58 0.362   1.91
## 5 NO2            3.50 0.317   0</code></pre>
<pre class="r"><code>ggplot(per.var.imp, aes(y=Rank, x=reorder(Variable, +Rank))) +
  ylab(&#39;Scale-Importance&#39;) +
  xlab(&#39;&#39;)+
  geom_bar(stat=&quot;identity&quot;, width = 0.45,fill = &quot;grey&quot;)+
  theme_bw() +
  theme(axis.line = element_line(colour = &quot;black&quot;),
        panel.grid.major = element_blank(),
        axis.text.y=element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12))+
  coord_flip()+
  ggtitle(&quot;Permutation-based Feature Importance&quot;)</code></pre>
<p><img src="geographically-wighted-random-forest_files/figure-html/unnamed-chunk-25-1.png" width="432" /></p>
</div>
<div id="partial-dependence-plot-pdp" class="section level2">
<h2>Partial dependence plot (PDP)</h2>
<p>To understand and visualize how the model predictions are influenced by each predictor when all other predictors are being controlled, we used the “pdp” package (Greenwell, 2017) to generate partial dependence plots (PDPs) of the first two important predictors for the best ML model. Partial dependence plots, introduced by Friedman (2001) (Friedman, 2001), is used to interpret the output of complex machine learning models. In PDPs, the Y-axis value (ŷ) is defined by the average of all of the possible model predictions when the value of the objective predictor is at X.</p>
<pre class="r"><code># Custom prediction function wrapper
pdp_pred &lt;- function(object, newdata)  {
  results &lt;- mean(as.vector(h2o.predict(object, as.h2o(newdata))))
  return(results)
}</code></pre>
<pre class="r"><code>var.names=per.var.imp[1]
var_1st=var.names[1,]$Variable
var_1st</code></pre>
<pre><code>## [1] &quot;SMOKING&quot;</code></pre>
<pre class="r"><code>var_2nd=var.names[2,]$Variable
var_2nd</code></pre>
<pre><code>## [1] &quot;POVERTY&quot;</code></pre>
<div id="the-1st-most-important-variables" class="section level3">
<h3>The 1st most Important Variables</h3>
<pre class="r"><code>pd_var_1st&lt;- partial(
  best_drf,
  train = as.data.frame(train.hex),
  pred.var = var_1st,
  pred.fun = pdp_pred,
  parallel = TRUE,
  grid.resolution = 10
)

pd_1&lt;-autoplot(pd_var_1st,
               rug = TRUE,
               train=as.data.frame(train.hex)) +
               theme(text = element_text(size=15))</code></pre>
</div>
<div id="the-2nd-most-important-variables" class="section level3">
<h3>The 2nd most Important Variables</h3>
<pre class="r"><code>pd_var_2nd&lt;- partial(
  best_drf,
  train = as.data.frame(train.hex),
  pred.var = var_2nd,
  pred.fun = pdp_pred,
  parallel = TRUE,
  grid.resolution = 10
)

pd_2&lt;-autoplot(pd_var_2nd,
               rug = TRUE,
               train=as.data.frame(train.hex)) +
               theme(text = element_text(size=15))</code></pre>
</div>
<div id="smoking-vs-poverty" class="section level3">
<h3>Smoking vs Poverty</h3>
<pre class="r"><code>pd_var_1st_2nd&lt;- partial(
  best_drf,
  train = as.data.frame(train.hex),
  pred.var = c(var_1st,var_2nd),
  pred.fun = pdp_pred,
  parallel = TRUE,
  grid.resolution = 10
)

pd_1_2&lt;-autoplot(pd_var_1st_2nd,
              contour = TRUE) +
              theme(text = element_text(size=15))</code></pre>
<pre class="r"><code>grid.arrange(pd_1,pd_2,pd_1_2, 
             ncol= 3,
             heights = c(40,8), 
             top = textGrob(&quot;Partial Dependence Plot&quot;, gp=gpar(fontsize=25)))</code></pre>
<p><img src="geographically-wighted-random-forest_files/figure-html/unnamed-chunk-31-1.png" width="1152" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>
<div id="local-random-forest" class="section level1">
<h1>Local Random Forest</h1>
<p>“Geographical Weighted Random Forest (GWRF) or local RF model is a spatial analysis method using a local version of the Random Forest Regresson Model. It allows for the investigation of the existence of spatial non-stationarity, in the relationship between a dependent and a set of independent variables. The latter is possible by fitting a sub-model for each observation in space, taking into account the neighbouring observations. This technique adopts the idea of the Geographically Weighted Regression, Kalogirou (2003). The main difference between a tradition (linear) GWR and GRF is that we can model non-stationarity coupled with a flexible non-linear model which is very hard to overfit due to its bootstrapping nature, thus relaxing the assumptions of traditional Gaussian statistics. Essential it was designed to be a bridge between machine learning and geographical models, combining inferential and explanatory power. Additionally, it is suited for datasets with numerous predictors, due to the robust nature of the random forest algorithm in high dimensionality.”</p>
<p>Geographical Weighted Random Forest (GRF) is based on the concept of spatially varying coefficient models (Fotheringham et al. 2003) where a global process becomes a decomposition of several local sub-models and can be used as a predictive and/or explanatory tool <a href="https://www.tandfonline.com/doi/full/10.1080/10106049.2019.1595177">(Geogoans et al, 2018)</a></p>
<p>To implement the GRF we use a recently developed R package <strong>SpatialML</strong> (Kalogirou and Georganos 2018; “SpatialML.” R Foundation for Statistical Computing)</p>
<pre class="r"><code>Coords&lt;-train.df[ ,2:3]
grf.model &lt;- grf(Rate ~ POVERTY+SMOKING+PM25+NO2+SO2, 
           dframe=train.df, 
           bw=162,             # a positive number, in the case of an &quot;adaptive kernel&quot; or a real in the case of a &quot;fixed kernel&quot;.
           ntree=   500, 
           mtry = 2,           # n integer referring to the number of trees to grow for each of the local random forests.
           kernel=&quot;adaptive&quot;,  # yhe kernel to be used in the regression. Options are &quot;adaptive&quot; or &quot;fixed&quot;.
           forests = TRUE,     # a option to save and export (TRUE) or not (FALSE) all the local forests
           coords=Coords)      # a numeric matrix or data frame of two columns giving the X,Y coordinates of the observations</code></pre>
<div id="global-variable-importnace" class="section level3">
<h3>Global Variable Importnace</h3>
<pre class="r"><code>grf.model$Global.Model$importance </code></pre>
<pre><code>##           %IncMSE IncNodePurity
## POVERTY  26.70089      20073.13
## SMOKING 112.45254      43345.33
## PM25     17.58009      11367.77
## NO2      14.81682      13391.54
## SO2       9.01535      11043.26</code></pre>
</div>
<div id="global-mean-mse" class="section level3">
<h3>Global Mean MSE</h3>
<pre class="r"><code>mean(grf.model$Global.Model$mse)</code></pre>
<pre><code>## [1] 71.87179</code></pre>
</div>
<div id="global-mean-r2" class="section level3">
<h3>Global Mean R2</h3>
<pre class="r"><code>mean(grf.model$Global.Model$rsq)</code></pre>
<pre><code>## [1] 0.5412476</code></pre>
</div>
<div id="local-model-summary-and-goodness-of-fit-statistics-training-and-oob" class="section level3">
<h3>Local Model Summary and goodness of fit statistics (training and OOB)</h3>
<pre class="r"><code>grf.model$LocalModelSummary</code></pre>
<pre><code>## $l.IncMSE
##                Min      Max      Mean      StD
## POVERTY -3.1553168 22.00167 10.138802 4.326018
## SMOKING 19.9068219 53.42578 38.880572 6.394213
## PM25    -0.5808945 20.48760 11.761499 3.644535
## NO2     -2.0807832 24.13955 11.278732 5.280920
## SO2     -0.6054641 21.40432  9.828823 4.164296
## 
## $l.IncNodePurity
##              Min       Max     Mean       StD
## POVERTY 1533.849  8235.350 3489.277 1290.3320
## SMOKING 4800.108 17856.038 8237.988 2754.8883
## PM25    1402.282  4342.134 2553.320  577.7603
## NO2     1262.982  3898.109 2586.017  688.2369
## SO2     1282.516  6775.013 2840.593 1188.0265
## 
## $l.RSS.OOB
## [1] 46218.12
## 
## $l.r.OOB
## [1] 0.5570466
## 
## $l.RSS.Pred
## [1] 9478.563
## 
## $l.r.Pred
## [1] 0.9091577</code></pre>
</div>
<div id="local-feature-importance-incmse" class="section level3">
<h3>Local feature importance (IncMSE)</h3>
<pre class="r"><code>gwrf.SPDF&lt;-shapefile(paste0(dataFolder,&quot;COUNTY_ATLANTIC.shp&quot;))
gwrf.SPDF@data$incMSE.SMOK=grf.model$Local.Pc.IncMSE$SMOK
gwrf.SPDF@data$incMSE.POV=grf.model$Local.Pc.IncMSE$POV
gwrf.SPDF@data$incMSE.PM25=grf.model$Local.Pc.IncMSE$PM25
gwrf.SPDF@data$incMSE.NO2=grf.model$Local.Pc.IncMSE$NO2
gwrf.SPDF@data$incMSE.SO2=grf.model$Local.Pc.IncMSE$SO2</code></pre>
<div id="plot-local-feature-importance-incmse" class="section level4">
<h4>Plot local feature importance (IncMSE)</h4>
<pre class="r"><code>col.palette.t&lt;-colorRampPalette(c(&quot;blue&quot;,  &quot;sky blue&quot;, &quot;green&quot;,&quot;yellow&quot;,&quot;pink&quot;, &quot;red&quot;),space=&quot;rgb&quot;,interpolate = &quot;linear&quot;) 

smok&lt;-spplot(gwrf.SPDF,&quot;incMSE.SMOK&quot;, main = &quot;Smoking&quot;, 
       sp.layout=list(state),
       col=&quot;transparent&quot;,
       col.regions=rev(col.palette.t(100)))

pov&lt;-spplot(gwrf.SPDF,&quot;incMSE.POV&quot;, main = &quot;Poverty&quot;, 
       sp.layout=list(state),
       col=&quot;transparent&quot;,
       col.regions=rev(col.palette.t(100)))

pm25&lt;-spplot(gwrf.SPDF,&quot;incMSE.PM25&quot;, main = &quot;PM25&quot;, 
       sp.layout=list(state),
       col=&quot;transparent&quot;,
       col.regions=rev(col.palette.t(100)))

no2&lt;-spplot(gwrf.SPDF,&quot;incMSE.NO2&quot;, main = &quot;NO2&quot;, 
      sp.layout=list(state),
      col=&quot;transparent&quot;,
      col.regions=rev(col.palette.t(100)))

so2&lt;-spplot(gwrf.SPDF,&quot;incMSE.NO2&quot;, main = &quot;SO2&quot;, 
      sp.layout=list(state),
      col=&quot;transparent&quot;,
      col.regions=rev(col.palette.t(100)))</code></pre>
<pre class="r"><code>grid.arrange(smok, pov, pm25, no2, so2,
             ncol=5, 
             heights = c(30,6), 
             top = textGrob(&quot;Local Feature Importance (IncMSE)&quot;,gp=gpar(fontsize=25)))</code></pre>
<p><img src="geographically-wighted-random-forest_files/figure-html/unnamed-chunk-39-1.png" width="1152" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="local-goodness-of-fit" class="section level3">
<h3>Local goodness of fit</h3>
<pre class="r"><code>county@data$loc_R2=grf.model$LGofFit$LM_Rsq100</code></pre>
<pre class="r"><code>myPaletteRes &lt;- colorRampPalette(c(&quot;lightseagreen&quot;,&quot;lightsteelblue1&quot;, &quot;moccasin&quot;,&quot;hotpink&quot;, &quot;red&quot;))
spplot(county,&quot;loc_R2&quot;, main = &quot;Local R2 (%)&quot;, 
       sp.layout=list(state),
       col=&quot;transparent&quot;,
       col.regions=myPaletteRes(100))</code></pre>
<p><img src="geographically-wighted-random-forest_files/figure-html/unnamed-chunk-41-1.png" width="384" style="display: block; margin: auto;" /></p>
</div>
<div id="prediction-1" class="section level3">
<h3>Prediction</h3>
<pre class="r"><code># Validation data
FIPS.xy$GWRF_2011&lt;-predict.grf(grf.model, valid.df, x.var.name=&quot;X&quot;, y.var.name=&quot;Y&quot;, local.w=1, global.w=0)
# Test data
FIPS.xy$GWRF_2012&lt;-predict.grf(grf.model, test.df, x.var.name=&quot;X&quot;, y.var.name=&quot;Y&quot;, local.w=1, global.w=0)</code></pre>
<pre class="r"><code>cat(&#39;GWRF Validation RMSE:&#39;, round(sqrt(mean((FIPS.xy$GWRF_2011-FIPS.xy$Obs_2011)^2 , na.rm = TRUE)), digits=3), &#39;\n&#39;)</code></pre>
<pre><code>## GWRF Validation RMSE: 7.307</code></pre>
<pre class="r"><code>cat(&#39;GWRF Validation MAE:&#39;, round(mean(abs(FIPS.xy$GWRF_2011-FIPS.xy$Obs_2011) , na.rm = TRUE ), digits=3), &#39;\n&#39;)</code></pre>
<pre><code>## GWRF Validation MAE: 5.594</code></pre>
<pre class="r"><code>cat(&#39;GWRF Validation R2:&#39;, round(summary(lm(Obs_2011~GWRF_2011,FIPS.xy))$r.squared, digits=3), &#39;\n&#39;)</code></pre>
<pre><code>## GWRF Validation R2: 0.683</code></pre>
<pre class="r"><code>cat(&#39;GWRF Test RMSE:&#39;, round(sqrt(mean((FIPS.xy$GWRF_2012-FIPS.xy$Obs_2012)^2 , na.rm = TRUE)), digits=3), &#39;\n&#39;)</code></pre>
<pre><code>## GWRF Test RMSE: 8.142</code></pre>
<pre class="r"><code>cat(&#39;GWRF Test MAE:&#39;, round(mean(abs(FIPS.xy$GWRF_2012-FIPS.xy$Obs_2012) , na.rm = TRUE ), digits=3), &#39;\n&#39;)</code></pre>
<pre><code>## GWRF Test MAE: 6.214</code></pre>
<pre class="r"><code>cat(&#39;GWRF Test R2:&#39;, round(summary(lm(Obs_2012~GWRF_2012,FIPS.xy))$r.squared, digits=3), &#39;\n&#39;)</code></pre>
<pre><code>## GWRF Test R2: 0.622</code></pre>
</div>
<div id="gwrf-predicted-11-plot" class="section level2">
<h2>GWRF Predicted 1:1 Plot</h2>
<div id="validation-data-year-2011-1" class="section level3">
<h3>Validation data (year 2011)</h3>
<pre class="r"><code>p1.valid&lt;-ggplot(data=FIPS.xy, aes(x=Obs_2011, y=GWRF_2011))+ 
  geom_point(size = 1.0)+
  geom_smooth(method = &quot;lm&quot;, se = FALSE, colour=&quot;black&quot;,size=0.5)+
  scale_x_continuous(limits=c(20,120), breaks=seq(20, 120, 20))+ 
  scale_y_continuous(limits=c(20,120), breaks=seq(20, 120, 20)) +
  theme_light() +
  ggtitle(&quot;Validation data: 2011&quot;)+
  theme(
    plot.title = element_text(color=&quot;black&quot;, size=12,hjust = 0.5),
    panel.background = element_rect(fill = &quot;white&quot;,colour = &quot;gray75&quot;,size = 0.5, linetype = &quot;solid&quot;),
    axis.line = element_line(colour = &quot;grey&quot;),
    panel.grid.major = element_blank(),
    axis.text.x=element_text(size=10, colour=&quot;black&quot;),
    axis.text.y=element_text(size=10,angle = 90,vjust = 0.5, hjust=0.5, colour=&#39;black&#39;))+
  geom_abline(slope=1, intercept=0,linetype=&quot;dashed&quot;,size=0.5)+
  labs(x=&quot;Observed&quot;, y = &quot;Predicted&quot;) </code></pre>
</div>
<div id="test-data-year-2012-1" class="section level3">
<h3>Test data (year 2012)</h3>
<pre class="r"><code>p1.test&lt;-ggplot(data=FIPS.xy, aes(x=Obs_2012, y=GWRF_2012))+ 
  geom_point(size = 1.0)+
  geom_smooth(method = &quot;lm&quot;, se = FALSE, colour=&quot;black&quot;,size=0.5)+
  scale_x_continuous(limits=c(20,120), breaks=seq(20, 120, 20))+ 
  scale_y_continuous(limits=c(20,120), breaks=seq(20, 120, 20)) +
  theme_light() +
  ggtitle(&quot;Test data - 2012&quot;)+
  theme(
    plot.title = element_text(color=&quot;black&quot;, size=12,hjust = 0.5),
    panel.background = element_rect(fill = &quot;white&quot;,colour = &quot;gray75&quot;,size = 0.5, linetype = &quot;solid&quot;),
    axis.line = element_line(colour = &quot;grey&quot;),
    panel.grid.major = element_blank(),
    axis.text.x=element_text(size=10, colour=&quot;black&quot;),
    axis.text.y=element_text(size=10,angle = 90,vjust = 0.5, hjust=0.5, colour=&#39;black&#39;))+
  geom_abline(slope=1, intercept=0,linetype=&quot;dashed&quot;,size=0.5)+
  labs(x=&quot;Observed&quot;, y = &quot;Predicted&quot;) </code></pre>
</div>
<div id="plot-all-1" class="section level3">
<h3>Plot all</h3>
<pre class="r"><code>grid.arrange(p1.valid,p1.test, 
            ncol= 2, 
            heights = c(30,6), 
            top = textGrob(&quot;GW Random Forest Predicted LBC Mortality Rate 
                          \n(death per 100,000)&quot;,gp=gpar(fontsize=18)))</code></pre>
<p><img src="geographically-wighted-random-forest_files/figure-html/unnamed-chunk-47-1.png" width="768" style="display: block; margin: auto;" /></p>
</div>
<div id="map-predicted-values-1" class="section level3">
<h3>Map predicted values</h3>
<pre class="r"><code>gwrf.SPDF&lt;-merge(county, FIPS.xy, by=&quot;FIPS&quot;)
names(gwrf.SPDF)</code></pre>
<pre><code>##  [1] &quot;FIPS&quot;       &quot;ID&quot;         &quot;x&quot;          &quot;y&quot;          &quot;REGION_ID&quot; 
##  [6] &quot;DIVISION_I&quot; &quot;STATE_ID&quot;   &quot;COUNTY_ID&quot;  &quot;REGION&quot;     &quot;DIVISION&quot;  
## [11] &quot;STATE&quot;      &quot;COUNTY&quot;     &quot;loc_R2&quot;     &quot;X&quot;          &quot;Y&quot;         
## [16] &quot;Obs_2011&quot;   &quot;Obs_2012&quot;   &quot;RF_2011&quot;    &quot;RF_2012&quot;    &quot;GWRF_2011&quot; 
## [21] &quot;GWRF_2012&quot;</code></pre>
<pre class="r"><code>myPalette &lt;- colorRampPalette(c(&quot;blue&quot;,&quot;green&quot;, &quot;yellow&quot;, &quot;red&quot;, &quot;red4&quot;))
#state &lt;- list(&quot;sp.lines&quot;, as(state, &quot;SpatialLines&quot;), col=&quot;grey50&quot;, lwd=.7,lty=3) 
spplot(gwrf.SPDF, 
        c(&quot;GWRF_2011&quot;, &quot;GWRF_2012&quot;, &quot;Obs_2011&quot;, &quot;Obs_2012&quot; ),         
         layout=c(2, 2),
         par.strip.text=list(cex=1, lines=1, col=&quot;black&quot;),
         main = list( &quot;GW Random Forest Predicted LBC Mortality Rate 
                 \n(death per 100,000)&quot;, adj = 0.5),
         sp.layout=list(state),
         par.settings=list(strip.background=list(col=&quot;transparent&quot;),
                             strip.border = list(col = &#39;grey95&#39;,lwd=0.5),
                             axis.line=list(col=&quot;grey95&quot;,lwd=0.5)),
         col=&quot;transparent&quot;,
         colorkey=list(space=&quot;right&quot;,height=1, width=2,labels=list(cex=1.75)),
         col.regions=myPalette(100))</code></pre>
<p><img src="geographically-wighted-random-forest_files/figure-html/unnamed-chunk-49-1.png" width="576" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
