<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>deep-learning-h2o.utf8</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Geospatial Data Science in R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="getting-started-with-r.html">Getting Started with R</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Spatial Data Processing
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="about.html">Content</a>
    </li>
    <li>
      <a href="read-write-spatial-data.html">Read and Write Spatial Data</a>
    </li>
    <li>
      <a href="map-projection-coordinate-reference-systems.html">Map Projection and Coordinate Reference Systems</a>
    </li>
    <li>
      <a href="geoprocessing-vector-data.html">Geoprocessing of Vector data</a>
    </li>
    <li>
      <a href="working-with-spatial-point-data.html">Working with Spatial Point Data</a>
    </li>
    <li>
      <a href="working-with-spatial-polygon.html">Working with Spatial Polygon Data</a>
    </li>
    <li>
      <a href="working-with-raster-data.html">Working with Raster Data</a>
    </li>
    <li>
      <a href="netCDF-data-processing.html">netCDF Data Processing</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Spatial Statistics
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="about-b.html">Content</a>
    </li>
    <li>
      <a href="spatial-autocorrelation.html">Spatial Autocorrelation</a>
    </li>
    <li>
      <a href="point-pattern-analysis.html">Point Pattern Analysis</a>
    </li>
    <li>
      <a href="geographically-weighted-models.html">Geographically Weighted Model</a>
    </li>
    <li>
      <a href="geographically-weighted-summary-statistics.html">Geographically Weighted Summary Statistics</a>
    </li>
    <li>
      <a href="geographically-weighted-principal-components-analysis.html">Geographically Weighted Principal Components Analysis</a>
    </li>
    <li>
      <a href="geographically-weighted-regression.html">Geographically Weighted Regression</a>
    </li>
    <li>
      <a href="geographically-weighted-ols-regression.html">Geographically Weighted OLS Regression</a>
    </li>
    <li>
      <a href="geographically-weighted-poisson-regression.html">Geographically Weighted Poisson Regression</a>
    </li>
    <li>
      <a href="geographically-wighted-random-forest.html">Global and Local (geographically weighted) Random Forest</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Spatial Interpolation
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="about-d.html">Content</a>
    </li>
    <li>
      <a href="deterministic-methods-for-spatial-interpolation.html">Deterministic Methods for Spatial Interpolation</a>
    </li>
    <li>
      <a href="geostatistical-methods-for-spatial-interpolation.html">Geostatistical Methods for Spatial Interpolation</a>
    </li>
    <li>
      <a href="semivariogram-modeling.html">Semivariogram Modeling</a>
    </li>
    <li>
      <a href="kriging.html">Kriging</a>
    </li>
    <li>
      <a href="ordinary-kriging.html">Ordinary Kriging</a>
    </li>
    <li>
      <a href="universal-kriging.html">Universal Kriging</a>
    </li>
    <li>
      <a href="cokriging.html">Co-Kriging</a>
    </li>
    <li>
      <a href="regression-kriging.html">Regression kriging</a>
    </li>
    <li>
      <a href="indicator-kriging.html">Indicator kriging</a>
    </li>
    <li>
      <a href="assessing-quality-spatial-predictions.html">Assessing the Quality of Spatial Predictions</a>
    </li>
    <li>
      <a href="cross-validation.html">Cross-validation</a>
    </li>
    <li>
      <a href="validation-independent-dataset.html">Validation with an Independent Dataset</a>
    </li>
    <li>
      <a href="conditional-simulation-spatial-uncertainty.html">Conditional Simulation for Spatial Uncertainty</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Remote Sensing
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="about-c.html">Content</a>
    </li>
    <li>
      <a href="reomte-sensing-basic.html">Remote Sensing Basic</a>
    </li>
    <li>
      <a href="landsat-8-image-processing.html">Landsat 8 Image Processing &amp; Visualization</a>
    </li>
    <li>
      <a href="spectral-indices.html">Spectral Indices</a>
    </li>
    <li>
      <a href="uav-ground-cover.html">Green Ground Cover from UAV Images</a>
    </li>
    <li>
      <a href="texture-analysis.html">Texture Analysis</a>
    </li>
    <li>
      <a href="image-classification.html">Image Classification</a>
    </li>
    <li>
      <a href="ground-truth-data-processing.html">Ground Truth Data Processing</a>
    </li>
    <li>
      <a href="unsupervised-classification.html">Unsupervised Classification</a>
    </li>
    <li>
      <a href="supervised-classification.html">Supervised Classification</a>
    </li>
    <li>
      <a href="random-forest.html">Random Forest</a>
    </li>
    <li>
      <a href="support-vector-machine.html">Support Vector Machine</a>
    </li>
    <li>
      <a href="naive-bayes.html">Naïve Bayes</a>
    </li>
    <li>
      <a href="exboost.html">eXtreme Gradient Boosting</a>
    </li>
    <li>
      <a href="deep-learning-h2o.html">Deep Learning with H20</a>
    </li>
    <li>
      <a href="stack-ensemble-h2o.html">Stack-Ensemble-H20</a>
    </li>
    <li>
      <a href="deep-learning-keras-tensorflow.html">Deep Learning with Keras-TensorFlow</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="mailto:zia207@gmail.com">
    <span class="fa fa-envelope fa-lg"></span>
     
    Email
  </a>
</li>
<li>
  <a href="http://github.com/zia207">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://www.linkedin.com/in/zia-ahmed-a7653578">
    <span class="fa fa-linkedin fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">




</div>


<div style="margin-bottom:10px;">

</div>
<img src="Image/empty_banner.png" width="100%" style="display: block; margin: auto;" />
<div style="margin-bottom:20px;">

</div>
<div style="margin-bottom:20px;">

</div>
<p><img src="Image/DNN_h2o.png" width="100%" style="display: block; margin: auto;" /></p>
<div style="margin-bottom:30px;">

</div>
<div id="deep-neural-network---supervised-image-classification-in-h20-r" class="section level1">
<h1>Deep Neural Network - Supervised Image Classification in H20 R</h1>
<div style="margin-bottom:20px;">

</div>
<p><strong>Deep Neural Networks (or Deep Dearning)</strong> is based on a multi-layer, feed-forward artificial neural network that is trained with stochastic gradient descent using back-propagation. The network can contain many hidden layers consisting of neurons with activation functions. Advanced features such as adaptive learning rate, rate annealing, momentum training, dropout, L1 or L2 regularization, checkpointing, and grid search enable high predictive accuracy. Each computer node trains a copy of the global model parameters on its local data with multi-threading (asynchronously) and contributes periodically to the global model via model averaging across the network.</p>
<p>In this tutorial will show how to implement a Deep Neural Network for pixel based supervised classification of Sentinel-2 multispectral images using the <a href="http://h2o-release.s3.amazonaws.com/h2o/rel-lambert/5/docs-website/Ruser/Rinstall.html">H20</a> package in R.</p>
<p><a href="http://docs.h2o.ai/h2o/latest-stable/h2o-docs/welcome.html">H2O is an open source, in-memory, distributed, fast, and scalable machine learning and predictive analytics platform that allows you to build machine learning models on big data and provides easy productionalization of those models in an enterprise environment</a>. It’s core code is written in Java and can read data in parallel from a distributed cluster and also from local cluster. H2O allows access to all the capabilities of H2O from an external program or script via JSON over HTTP. The Rest API is used by H2O’s <a href="http://docs.h2o.ai/h2o/latest-stable/h2o-docs/welcome.html">web interface (Flow UI)</a>, <a href="http://docs.h2o.ai/h2o/latest-stable/h2o-docs/welcome.html">R binding (H2O-R)</a>, and <a href="http://docs.h2o.ai/h2o/latest-stable/h2o-docs/welcome.html">Python binding (H2O-Python)</a>. Requirement and installation steps in R can be found <a href="http://h2o-release.s3.amazonaws.com/h2o/rel-wheeler/2/index.html">here</a>.</p>
<p>First, we will split the “point_data” into a training set (75% of the data), a validation set (12%) and a test set (13%) data. The validation data set will be used to optimize the model parameters during the training process. The model’s performance will be tested with the test data set. Finally, we will predict land use classes using a grid data set.</p>
<div id="load-packages" class="section level4">
<h4>Load packages</h4>
<pre class="r"><code>library(rgdal)         # spatial data processing
library(raster)        # raster processing
library(plyr)          # data manipulation 
library(dplyr)         # data manipulation 
library(RStoolbox)     # plotting raster data 
library(ggplot2)       # plotting 
library(RColorBrewer)  # Color
library(sp)            # Spatial data
library(ggplot2)       # Plotting</code></pre>
<div style="margin-bottom:20px;">

</div>
<p>The data could be available for download from <a href="https://www.dropbox.com/s/bupqmsfyr2tk1yg/Data_RS_DNN.7z?dl=0">here</a>.</p>
<div style="margin-bottom:20px;">

</div>
<pre class="r"><code># Define data folder
dataFolder&lt;-&quot;D:\\Dropbox\\Spatial Data Analysis and Processing in R\\DATA_RS_DNN\\&quot;</code></pre>
</div>
<div id="load-point-and-grid-data" class="section level4">
<h4>Load point and grid data</h4>
<pre class="r"><code>point&lt;-read.csv(paste0(dataFolder,&quot;.\\Sentinel_2\\point_data.csv&quot;), header = T)
grid&lt;-read.csv(paste0(dataFolder,&quot;.\\Sentinel_2\\prediction_grid_data.csv&quot;), header = T)</code></pre>
<div id="creat-data-frames" class="section level5">
<h5>Creat data frames</h5>
<pre class="r"><code>point.data&lt;-cbind(point[c(3:13)])
grid.data&lt;-grid[c(4:13)]
grid.xy&lt;-grid[c(3,1:2)]</code></pre>
</div>
</div>
<div id="install-h2o" class="section level4">
<h4>Install H2O</h4>
<pre class="r"><code>#install.packages(&quot;h20&quot;)</code></pre>
</div>
<div id="start-and-initialize-h20-local-cluster" class="section level4">
<h4>Start and Initialize H20 local cluster</h4>
<pre class="r"><code>library(h2o)
localH2o &lt;- h2o.init(nthreads = -1) </code></pre>
</div>
<div id="import-data-to-h2o-cluster" class="section level4">
<h4>Import data to H2O cluster</h4>
<pre class="r"><code>df&lt;-  as.h2o(point.data)
grid&lt;- as.h2o(grid.data)</code></pre>
</div>
<div id="split-data-into-train-validation-and-test-dataset" class="section level4">
<h4>Split data into train, validation and test dataset</h4>
<pre class="r"><code>splits &lt;- h2o.splitFrame(df, c(0.75,0.125), seed=1234)
train  &lt;- h2o.assign(splits[[1]], &quot;train.hex&quot;) # 75%
valid  &lt;- h2o.assign(splits[[2]], &quot;valid.hex&quot;) # 12%
test   &lt;- h2o.assign(splits[[3]], &quot;test.hex&quot;)  # 13%</code></pre>
</div>
<div id="create-response-and-features-data-sets" class="section level4">
<h4>Create response and features data sets</h4>
<pre class="r"><code>y &lt;- &quot;Class&quot;
x &lt;- setdiff(names(train), y)</code></pre>
<div style="margin-bottom:20px;">

</div>
</div>
<div id="tuning-and-optimizations-parameters" class="section level2">
<h2><strong>Tuning and Optimizations parameters:</strong></h2>
<p>More details about the of Tuning and Optimization parameters of the H20 Deep Neural Network for supervised classification can be found <a href="http://docs.h2o.ai/h2o-tutorials/latest-stable/tutorials/deeplearning/index.html">here</a></p>
<div id="grid-search-for-hyperprameters" class="section level3">
<h3>Grid Search for hyperprameters</h3>
<p>We can use the h2o.grid() function to perform a Random Grid Search (RGS). We could also test all possible combinations of parameters with Cartesian Grid or exhaustive search, but RGS is much faster when we have a large number of possible combinations and usually finds sufficiently accurate models.For RGS, we first define a set of hyper-parameters and search criteria to fine-tune our models. Because there are many hyper-parameters, each with a range of possible values, we want to find an (ideally) optimal combination to maximize our model’s accuracy.</p>
<p><strong>Activation Functions</strong></p>
<p><strong>Rectifier:</strong> is the default activation function. It is the fastest and most versatile option. It can lead to instability though and tends to be lower in accuracy. <strong>Tanh</strong>: The hyperbolic tangent is a scaled and shifted variant of the sigmoid activation function. It can take on values from -1 to 1 and centers around 0. Tanh needs more computational power than e.g. the Rectifier function. <strong>Maxout</strong>: is an activation function that is the max of the inputs. It is computationally quite demanding but can produce high accuracy models. ** …WithDropout:** When we specify with dropout, a random subset of the network is trained and the weights of all sub-networks are averaged. It works together with the parameter hidden_dropout_ratios, which controls the amount of layer neurons that are randomly dropped for each hidden layer. Hidden dropout ratios are useful for preventing overfitting on learned features.</p>
<p><strong>Hidden layers</strong></p>
<p>are the most important hyper-parameter to set for deep neural networks, as they specify how many hidden layers and how many nodes per hidden layer the model should learn</p>
<p><strong>L1 and L2 penalties</strong></p>
<p>L1: lets only strong weights survive L2: prevents any single weight from getting too big.</p>
<p><strong>rho</strong> Adaptive learning rate time decay factor (similarity to prior updates). Defaults to 0.99. <strong>epsilon</strong> Adaptive learning rate smoothing factor (to avoid divisions by zero and allow progress). Defaults to 1e-08.</p>
<p><strong>momentum_start</strong> Initial momentum at the beginning of training (try 0.5). Defaults to 0. <strong>momentum_stable</strong> Final momentum after the ramp is over (try 0.99). Defaults to 0. <strong>max_w2</strong> Constraint for squared sum of incoming weights per unit (e.g. for Rectifier). Defaults to 3.4028235e+38.</p>
<pre class="r"><code>hyper_params &lt;- list(
                     activation = c(&quot;Rectifier&quot;, &quot;Maxout&quot;, &quot;Tanh&quot;,
                                    &quot;RectifierWithDropout&quot;, &quot;MaxoutWithDropout&quot;,
                                    &quot;TanhWithDropout&quot;),                      
                     hidden = list(c(5, 5, 5, 5, 5), c(10, 10, 10, 10), c(50, 50, 50), c(100, 100, 100)),
                     epochs = c(50, 100, 200),
                     l1 = c(0, 0.00001, 0.0001), 
                     l2 = c(0, 0.00001, 0.0001),
                     rate = c(0, 01, 0.005, 0.001),
                     rate_annealing = c(1e-8, 1e-7, 1e-6),
                     rho = c(0.9, 0.95, 0.99, 0.999),
                     epsilon = c(1e-10, 1e-8, 1e-6, 1e-4),
                     momentum_start = c(0, 0.5),
                     momentum_stable = c(0.99, 0.5, 0),
                     input_dropout_ratio = c(0, 0.1, 0.2),
                     max_w2 = c(10, 100, 1000, 3.4028235e+38)
                     )
hyper_params</code></pre>
<pre><code>## $activation
## [1] &quot;Rectifier&quot;            &quot;Maxout&quot;               &quot;Tanh&quot;                
## [4] &quot;RectifierWithDropout&quot; &quot;MaxoutWithDropout&quot;    &quot;TanhWithDropout&quot;     
## 
## $hidden
## $hidden[[1]]
## [1] 5 5 5 5 5
## 
## $hidden[[2]]
## [1] 10 10 10 10
## 
## $hidden[[3]]
## [1] 50 50 50
## 
## $hidden[[4]]
## [1] 100 100 100
## 
## 
## $epochs
## [1]  50 100 200
## 
## $l1
## [1] 0e+00 1e-05 1e-04
## 
## $l2
## [1] 0e+00 1e-05 1e-04
## 
## $rate
## [1] 0.000 1.000 0.005 0.001
## 
## $rate_annealing
## [1] 1e-08 1e-07 1e-06
## 
## $rho
## [1] 0.900 0.950 0.990 0.999
## 
## $epsilon
## [1] 1e-10 1e-08 1e-06 1e-04
## 
## $momentum_start
## [1] 0.0 0.5
## 
## $momentum_stable
## [1] 0.99 0.50 0.00
## 
## $input_dropout_ratio
## [1] 0.0 0.1 0.2
## 
## $max_w2
## [1] 1.000000e+01 1.000000e+02 1.000000e+03 3.402823e+38</code></pre>
</div>
<div id="early-stopping-criteria" class="section level3">
<h3>Early stopping criteria</h3>
<p><strong>stopping_metric:</strong> metric that we want to use as stopping criterion <strong>stopping_tolerance and stopping_rounds</strong>: training stops when the the stopping metric does not improve by the stopping tolerance proportion any more (e.g. by 0.05 or 5%) for the number of consecutive rounds defined by stopping rounds.</p>
<pre class="r"><code>search_criteria &lt;- list(strategy = &quot;RandomDiscrete&quot;, 
                        max_models = 200,
                        max_runtime_secs = 900,
                        stopping_tolerance = 0.001,
                        stopping_rounds = 2,
                        seed = 1345767)</code></pre>
<p>Now, we can train the model with combinations of hyper-parameters from our specified stopping criteria and hyper-parameter grid.</p>
<pre class="r"><code>DNN_grid &lt;- h2o.grid(
                  algorithm=&quot;deeplearning&quot;,
                  grid_id = &quot;DNN_grid_ID&quot;,
                  x= x,
                  y = y,
                  training_frame = train,
                  validation_frame =valid,  
                  stopping_metric = &quot;logloss&quot;,
                  nfolds=10,
                  hyper_params = hyper_params,
                  search_criteria = search_criteria,
                  seed = 42)</code></pre>
<div id="grid-parameters" class="section level4">
<h4>Grid parameters</h4>
<pre class="r"><code>grid.dnn &lt;- h2o.getGrid(&quot;DNN_grid_ID&quot;,sort_by=&quot;RMSE&quot;,decreasing=FALSE)</code></pre>
<pre class="r"><code>grid.dnn@summary_table[1,]</code></pre>
<pre><code>## Hyper-Parameter Search Summary: ordered by increasing RMSE
##   activation            epochs epsilon          hidden input_dropout_ratio
## 1  Rectifier 54.90401746522839  1.0E-6 [100, 100, 100]                 0.1
##       l1     l2       max_w2 momentum_stable momentum_start  rate
## 1 1.0E-5 1.0E-4 3.4028235E38             0.5            0.5 0.001
##   rate_annealing   rho           model_ids              rmse
## 1         1.0E-8 0.999 DNN_grid_ID_model_2 0.470386190742813</code></pre>
</div>
</div>
<div id="the-best-model" class="section level3">
<h3>The Best Model</h3>
<pre class="r"><code>best_model &lt;- h2o.getModel(grid.dnn@model_ids[[1]]) ## model with lowest logloss
best_model</code></pre>
<pre><code>## Model Details:
## ==============
## 
## H2OMultinomialModel: deeplearning
## Model ID:  DNN_grid_ID_model_2 
## Status of Neuron Layers: predicting Class, 5-class classification, multinomial distribution, CrossEntropy loss, 21,805 weights/biases, 264.3 KB, 990,423 training samples, mini-batch size 1
##   layer units      type dropout       l1       l2 mean_rate rate_rms
## 1     1    10     Input 10.00 %       NA       NA        NA       NA
## 2     2   100 Rectifier  0.00 % 0.000010 0.000100  0.232140 0.353428
## 3     3   100 Rectifier  0.00 % 0.000010 0.000100  0.125663 0.182956
## 4     4   100 Rectifier  0.00 % 0.000010 0.000100  0.093742 0.131992
## 5     5     5   Softmax      NA 0.000010 0.000100  0.210622 0.301976
##   momentum mean_weight weight_rms mean_bias bias_rms
## 1       NA          NA         NA        NA       NA
## 2 0.000000    0.037330   0.811123 -0.604619 0.756887
## 3 0.000000   -0.129726   0.341419 -0.316837 0.918432
## 4 0.000000   -0.090741   0.247213 -0.229974 0.728232
## 5 0.000000   -0.220408   0.508440 -0.205010 0.375579
## 
## 
## H2OMultinomialMetrics: deeplearning
## ** Reported on training data. **
## ** Metrics reported on temporary training frame with 10047 samples **
## 
## Training Set Metrics: 
## =====================
## 
## MSE: (Extract with `h2o.mse`) 0.1760582
## RMSE: (Extract with `h2o.rmse`) 0.4195929
## Logloss: (Extract with `h2o.logloss`) 0.7361873
## Mean Per-Class Error: 0.160612
## Confusion Matrix: Extract with `h2o.confusionMatrix(&lt;model&gt;,train = TRUE)`)
## =========================================================================
## Confusion Matrix: Row labels: Actual class; Column labels: Predicted class
##         Class_1 Class_2 Class_3 Class_4 Class_5  Error             Rate
## Class_1    1811     448      51       1       0 0.2164 =    500 / 2,311
## Class_2      11    1881       5      10       0 0.0136 =     26 / 1,907
## Class_3      33     225    1536    1577       0 0.5443 =  1,835 / 3,371
## Class_4       0       0       0    2075       0 0.0000 =      0 / 2,075
## Class_5       0       0       0      11     372 0.0287 =       11 / 383
## Totals     1855    2554    1592    3674     372 0.2361 = 2,372 / 10,047
## 
## Hit Ratio Table: Extract with `h2o.hit_ratio_table(&lt;model&gt;,train = TRUE)`
## =======================================================================
## Top-5 Hit Ratios: 
##   k hit_ratio
## 1 1  0.763910
## 2 2  0.963173
## 3 3  0.979795
## 4 4  0.998706
## 5 5  1.000000
## 
## 
## H2OMultinomialMetrics: deeplearning
## ** Reported on validation data. **
## ** Metrics reported on full validation frame **
## 
## Validation Set Metrics: 
## =====================
## 
## Extract validation frame with `h2o.getFrame(&quot;valid.hex&quot;)`
## MSE: (Extract with `h2o.mse`) 0.1801899
## RMSE: (Extract with `h2o.rmse`) 0.4244878
## Logloss: (Extract with `h2o.logloss`) 0.7429584
## Mean Per-Class Error: 0.1566076
## Confusion Matrix: Extract with `h2o.confusionMatrix(&lt;model&gt;,valid = TRUE)`)
## =========================================================================
## Confusion Matrix: Row labels: Actual class; Column labels: Predicted class
##         Class_1 Class_2 Class_3 Class_4 Class_5  Error          Rate
## Class_1     520     132       8       0       0 0.2121 =   140 / 660
## Class_2       3     535       3       3       0 0.0165 =     9 / 544
## Class_3      10      74     456     463       0 0.5454 = 547 / 1,003
## Class_4       0       0       0     606       0 0.0000 =     0 / 606
## Class_5       0       0       0       1     110 0.0090 =     1 / 111
## Totals      533     741     467    1073     110 0.2384 = 697 / 2,924
## 
## Hit Ratio Table: Extract with `h2o.hit_ratio_table(&lt;model&gt;,valid = TRUE)`
## =======================================================================
## Top-5 Hit Ratios: 
##   k hit_ratio
## 1 1  0.761628
## 2 2  0.961354
## 3 3  0.978454
## 4 4  0.998290
## 5 5  1.000000
## 
## 
## H2OMultinomialMetrics: deeplearning
## ** Reported on cross-validation data. **
## ** 10-fold cross-validation on training data (Metrics computed for combined holdout predictions) **
## 
## Cross-Validation Set Metrics: 
## =====================
## 
## Extract cross-validation frame with `h2o.getFrame(&quot;train.hex&quot;)`
## MSE: (Extract with `h2o.mse`) 0.2212632
## RMSE: (Extract with `h2o.rmse`) 0.4703862
## Logloss: (Extract with `h2o.logloss`) 1.6499
## Mean Per-Class Error: 0.2081824
## Hit Ratio Table: Extract with `h2o.hit_ratio_table(&lt;model&gt;,xval = TRUE)`
## =======================================================================
## Top-5 Hit Ratios: 
##   k hit_ratio
## 1 1  0.745592
## 2 2  0.920095
## 3 3  0.964068
## 4 4  0.985195
## 5 5  1.000000
## 
## 
## Cross-Validation Metrics Summary: 
##                               mean          sd cv_1_valid cv_2_valid
## accuracy                0.72726613  0.10143057  0.5642332  0.8605042
## err                     0.27273387  0.10143057 0.43576685  0.1394958
## err_count                    494.7   186.68692      770.0      249.0
## logloss                  2.1224914    0.900157   4.710472  1.1372237
## max_per_class_error     0.56307185  0.17311826 0.85337245 0.30445546
## mean_per_class_accuracy 0.77496237  0.07332822   0.615478 0.86763567
## mean_per_class_error    0.22503766  0.07332822 0.38452202 0.13236436
## mse                      0.2502878 0.093331896 0.38905162 0.12600179
## r2                      0.81274986  0.06973768 0.70802754  0.9077384
## rmse                     0.4817903  0.09530455    0.62374 0.35496733
##                         cv_3_valid cv_4_valid cv_5_valid cv_6_valid
## accuracy                0.70873785  0.5164776 0.79129463 0.68452704
## err                     0.29126215 0.48352242 0.20870535 0.31547293
## err_count                    540.0      895.0      374.0      577.0
## logloss                  1.8417213   3.060291  1.1676286  3.0341299
## max_per_class_error      0.5553822 0.86550635 0.57831323  0.7671233
## mean_per_class_accuracy  0.7834809  0.6521569 0.79759353 0.73732686
## mean_per_class_error    0.21651912  0.3478431 0.20240644 0.26267314
## mse                     0.27668488 0.44609764 0.18607819 0.29568365
## r2                       0.7879319  0.6682215  0.8611427 0.78153163
## rmse                     0.5260084  0.6679054  0.4313678   0.543768
##                         cv_7_valid cv_8_valid  cv_9_valid cv_10_valid
## accuracy                  0.520503  0.8435262  0.87464225   0.9082153
## err                       0.479497 0.15647383  0.12535776   0.0917847
## err_count                    877.0      284.0       219.0       162.0
## logloss                  3.1967516  1.8664871   0.6812789  0.52892935
## max_per_class_error      0.8433544 0.29095355  0.35263157  0.21962617
## mean_per_class_accuracy  0.6395614  0.8642869   0.8760884   0.9160149
## mean_per_class_error     0.3604386 0.13571309 0.123911634 0.083985075
## mse                     0.44122398 0.14656916  0.11415761  0.08132956
## r2                       0.6703911 0.88894665  0.91305345    0.940514
## rmse                     0.6642469 0.38284352  0.33787218  0.28518337</code></pre>
<div id="the-best-parameters" class="section level4">
<h4>The Best parameters</h4>
<pre class="r"><code>best_params &lt;- best_model@allparameters</code></pre>
</div>
<div id="mean-error" class="section level4">
<h4>Mean error</h4>
<pre class="r"><code>h2o.mean_per_class_error(best_model, train = TRUE, valid = TRUE, xval = TRUE)</code></pre>
<pre><code>##     train     valid      xval 
## 0.1606120 0.1566076 0.2081824</code></pre>
</div>
<div id="scoring-history" class="section level4">
<h4>Scoring history</h4>
<pre class="r"><code>scoring_history&lt;-best_model@model$scoring_history
#scoring_history
#write.csv(scoring_history, &quot;scoring_history_model_02.csv&quot;)</code></pre>
</div>
<div id="plot-the-classification-error" class="section level4">
<h4>Plot the classification error</h4>
<pre class="r"><code>plot(best_model,
     timestep = &quot;epochs&quot;,
     metric = &quot;classification_error&quot;)</code></pre>
<p><img src="deep-learning-h2o_files/figure-html/unnamed-chunk-21-1.png" width="480" /></p>
</div>
<div id="plot-logloss" class="section level4">
<h4>Plot logloss</h4>
<pre class="r"><code>plot(best_model,
     timestep = &quot;epochs&quot;,
     metric = &quot;logloss&quot;)</code></pre>
<p><img src="deep-learning-h2o_files/figure-html/unnamed-chunk-22-1.png" width="480" /></p>
</div>
<div id="cross-validation-result" class="section level4">
<h4>Cross validation result</h4>
<pre class="r"><code>print(best_model@model$cross_validation_metrics_summary%&gt;%.[,c(1,2)])</code></pre>
<pre><code>##                               mean          sd
## accuracy                0.72726613  0.10143057
## err                     0.27273387  0.10143057
## err_count                    494.7   186.68692
## logloss                  2.1224914    0.900157
## max_per_class_error     0.56307185  0.17311826
## mean_per_class_accuracy 0.77496237  0.07332822
## mean_per_class_error    0.22503766  0.07332822
## mse                      0.2502878 0.093331896
## r2                      0.81274986  0.06973768
## rmse                     0.4817903  0.09530455</code></pre>
<pre class="r"><code>#capture.output(print(dl_model@model$cross_validation_metrics_summary%&gt;%.[,c(1,2)]),file =  &quot;DL_CV_model_01.txt&quot;)</code></pre>
</div>
<div id="model-performance-with-test-data-set" class="section level4">
<h4>Model performance with Test data set</h4>
</div>
<div id="compare-the-training-error-with-the-validation-and-test-set-errors" class="section level4">
<h4>Compare the training error with the validation and test set errors</h4>
<pre class="r"><code>h2o.performance(best_model, newdata=train)     ## full train data</code></pre>
<pre><code>## H2OMultinomialMetrics: deeplearning
## 
## Test Set Metrics: 
## =====================
## 
## MSE: (Extract with `h2o.mse`) 0.1781435
## RMSE: (Extract with `h2o.rmse`) 0.4220705
## Logloss: (Extract with `h2o.logloss`) 0.7508721
## Mean Per-Class Error: 0.1604564
## Confusion Matrix: Extract with `h2o.confusionMatrix(&lt;model&gt;, &lt;data&gt;)`)
## =========================================================================
## Confusion Matrix: Row labels: Actual class; Column labels: Predicted class
##         Class_1 Class_2 Class_3 Class_4 Class_5  Error             Rate
## Class_1    3228     834     101       3       0 0.2252 =    938 / 4,166
## Class_2      30    3264       8      18       0 0.0169 =     56 / 3,320
## Class_3      48     397    2830    2840       0 0.5372 =  3,285 / 6,115
## Class_4       0       0       0    3739       0 0.0000 =      0 / 3,739
## Class_5       0       0       0      16     678 0.0231 =       16 / 694
## Totals     3306    4495    2939    6616     678 0.2382 = 4,295 / 18,034
## 
## Hit Ratio Table: Extract with `h2o.hit_ratio_table(&lt;model&gt;, &lt;data&gt;)`
## =======================================================================
## Top-5 Hit Ratios: 
##   k hit_ratio
## 1 1  0.761839
## 2 2  0.963624
## 3 3  0.979261
## 4 4  0.998725
## 5 5  1.000000</code></pre>
<pre class="r"><code>h2o.performance(best_model, newdata=valid)     ## full validation data</code></pre>
<pre><code>## H2OMultinomialMetrics: deeplearning
## 
## Test Set Metrics: 
## =====================
## 
## MSE: (Extract with `h2o.mse`) 0.1801899
## RMSE: (Extract with `h2o.rmse`) 0.4244878
## Logloss: (Extract with `h2o.logloss`) 0.7429584
## Mean Per-Class Error: 0.1566076
## Confusion Matrix: Extract with `h2o.confusionMatrix(&lt;model&gt;, &lt;data&gt;)`)
## =========================================================================
## Confusion Matrix: Row labels: Actual class; Column labels: Predicted class
##         Class_1 Class_2 Class_3 Class_4 Class_5  Error          Rate
## Class_1     520     132       8       0       0 0.2121 =   140 / 660
## Class_2       3     535       3       3       0 0.0165 =     9 / 544
## Class_3      10      74     456     463       0 0.5454 = 547 / 1,003
## Class_4       0       0       0     606       0 0.0000 =     0 / 606
## Class_5       0       0       0       1     110 0.0090 =     1 / 111
## Totals      533     741     467    1073     110 0.2384 = 697 / 2,924
## 
## Hit Ratio Table: Extract with `h2o.hit_ratio_table(&lt;model&gt;, &lt;data&gt;)`
## =======================================================================
## Top-5 Hit Ratios: 
##   k hit_ratio
## 1 1  0.761628
## 2 2  0.961354
## 3 3  0.978454
## 4 4  0.998290
## 5 5  1.000000</code></pre>
<pre class="r"><code>h2o.performance(best_model, newdata=test)     ## full test data</code></pre>
<pre><code>## H2OMultinomialMetrics: deeplearning
## 
## Test Set Metrics: 
## =====================
## 
## MSE: (Extract with `h2o.mse`) 0.1740729
## RMSE: (Extract with `h2o.rmse`) 0.4172204
## Logloss: (Extract with `h2o.logloss`) 0.7278218
## Mean Per-Class Error: 0.1565322
## Confusion Matrix: Extract with `h2o.confusionMatrix(&lt;model&gt;, &lt;data&gt;)`)
## =========================================================================
## Confusion Matrix: Row labels: Actual class; Column labels: Predicted class
##         Class_1 Class_2 Class_3 Class_4 Class_5  Error          Rate
## Class_1     554     139      15       0       0 0.2175 =   154 / 708
## Class_2       4     558       1       2       0 0.0124 =     7 / 565
## Class_3       8      67     447     457       0 0.5434 =   532 / 979
## Class_4       0       0       0     628       0 0.0000 =     0 / 628
## Class_5       0       0       0       1     106 0.0093 =     1 / 107
## Totals      566     764     463    1088     106 0.2323 = 694 / 2,987
## 
## Hit Ratio Table: Extract with `h2o.hit_ratio_table(&lt;model&gt;, &lt;data&gt;)`
## =======================================================================
## Top-5 Hit Ratios: 
##   k hit_ratio
## 1 1  0.767660
## 2 2  0.963174
## 3 3  0.978574
## 4 4  0.999330
## 5 5  1.000000</code></pre>
<pre class="r"><code>#capture.output(print(h2o.performance(dl_model,test)),file =  &quot;test_data_model_01.txt&quot;)</code></pre>
</div>
<div id="confusion-matrix" class="section level4">
<h4>Confusion matrix</h4>
<pre class="r"><code>train.cf&lt;-h2o.confusionMatrix(best_model)
print(train.cf)
valid.cf&lt;-h2o.confusionMatrix(best_model,valid=TRUE)
print(valid.cf)
test.cf&lt;-h2o.confusionMatrix(best_model,test)
print(test.cf)
#write.csv(train.cf, &quot;CFM_train_model_01.csv&quot;)
#write.csv(valid.cf, &quot;CFM_valid_model_01.csv&quot;)
#write.csv(test.cf, &quot;CFM_test_moldel_01.csv&quot;)</code></pre>
</div>
<div id="grid-prediction" class="section level4">
<h4>Grid Prediction</h4>
<pre class="r"><code>g.predict = as.data.frame(h2o.predict(object = best_model, newdata = grid))</code></pre>
</div>
<div id="stop-h20-cluster" class="section level4">
<h4>Stop h20 cluster</h4>
<pre class="r"><code>h2o.shutdown(prompt=FALSE)</code></pre>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="extract-prediction-class" class="section level4">
<h4>Extract Prediction Class</h4>
<pre class="r"><code># Extract predicted landuse class
grid.xy$Class&lt;-g.predict$predict  
# Import lnaduse ID file 
ID&lt;-read.csv(paste0(dataFolder,&quot;.\\Sentinel_2\\Landuse_ID.csv&quot;), header=T)
# Join landuse ID
grid.new&lt;-join(grid.xy, ID, by=&quot;Class&quot;, type=&quot;inner&quot;) 
# Omit missing values
grid.new.na&lt;-na.omit(grid.new)                                                            </code></pre>
</div>
<div id="convert-to-raster-and-write" class="section level4">
<h4>Convert to raster and write</h4>
<pre class="r"><code>x&lt;-SpatialPointsDataFrame(as.data.frame(grid.new.na)[, c(&quot;x&quot;, &quot;y&quot;)], data = grid.new.na)
r &lt;- rasterFromXYZ(as.data.frame(x)[, c(&quot;x&quot;, &quot;y&quot;, &quot;Class_ID&quot;)])</code></pre>
</div>
<div id="plot-map" class="section level4">
<h4>Plot map</h4>
<pre class="r"><code># Create color palette
myPalette &lt;- colorRampPalette(c(&quot;light grey&quot;,&quot;burlywood4&quot;, &quot;forestgreen&quot;,&quot;light green&quot;, &quot;dodgerblue&quot;))
# Plot Map
LU&lt;-spplot(r,&quot;Class_ID&quot;, main=&quot;Supervised Image Classification: Deep Learning-H20&quot; , 
      colorkey = list(space=&quot;right&quot;,tick.number=1,height=1, width=1.5,
              labels = list(at = seq(1,4.8,length=5),cex=1.0,
              lab = c(&quot;Road/parking/pavement&quot; ,&quot;Building&quot;, &quot;Tree/buses&quot;, &quot;Grass&quot;, &quot;Water&quot;))),
              col.regions=myPalette,cut=4)
LU</code></pre>
<p><img src="deep-learning-h2o_files/figure-html/unnamed-chunk-30-1.png" width="624" style="display: block; margin: auto;" /></p>
</div>
<div id="write-raster" class="section level4">
<h4>Write raster</h4>
<pre class="r"><code># writeRaster(r, filename = paste0(dataFolder,&quot;.\\Sentinel_2\\DNN_H20_Landuse.tiff&quot;), &quot;GTiff&quot;, overwrite=T)</code></pre>
<pre class="r"><code>rm(list = ls())</code></pre>
</div>
</div>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
